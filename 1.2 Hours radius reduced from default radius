-- 2. hours of radius reductions with respect to the the default radiuses have we had during the timeframe provided for each delivery area?
-- there are some issues with hours conversion and summing up

-- reduction with respect to default radius. 
-- edge cases- 1. a radius reduced after default.
-- 2. radius expanded after default. Then reduced after expansion. at timestamp 2022-01-15 20:46:37.995 +0100
-- we are considering when radius is reduced irrespective whether it was reduced from default or larger. 
-- Considered time from the moment reduced from default and until regained to default.

with q1 as (
select *
from delivery_radius_log drl 
-- where delivery_area_id = '5cc1b60b034adf90cd8f14dd'
order by event_started_timestamp asc 
),
q2 as (
select *,
lag(delivery_radius_meters) over(partition by delivery_area_id order by event_started_timestamp) prev_dr,
lag(event_started_timestamp) over(partition by delivery_area_id order by event_started_timestamp) prev_ts
from q1
),
q3 as (
select * , abs(extract(EPOCH from (event_started_timestamp- prev_ts))/3600) as hours,
case when abs(extract(EPOCH from (event_started_timestamp- prev_ts))/3600) >= 24 then 1 
else 0 end _default,
case when delivery_radius_meters>prev_dr then 1 
else -1 end red_exp 
from q2
where prev_dr is not null -- excluding the first record in a group when there is no change
)
select sum(hours)::int -- delivery_area_id , 
from q3
where _default= 0 -- excluding the default radius
and red_exp= -1 -- selecting only radius reduction records
-- group by 1
